<html>
  <head>
    <title>US SEIR model fits</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  </head>
  <body>
    <!--The SELECT element.-->
    <select id="sel" onchange="show(this)">
      <option value="">-- Select --</option>
    </select>

    <p id="msg"></p>
    <div class="chart-container" style="position: relative; height: 40vh; width: 60vw">
      <canvas id="graph" width="300" height="150" style="border: 1px solid">
        Your browser does not support the HTML5 canvas tag.
      </canvas>
    </div>

    <script>
      let myChart = document.getElementById('graph').getContext('2d')
      let infectChart = new Chart(myChart, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Documented',
              data: [],
              borderColor: 'blue',
              pointRadius: 0,
              hoverBorderWidth: 1,
              hoverBorderColor: '#000',
              fill: false,
            },
            {
              label: 'Model',
              data: [],
              borderColor: 'red',
              pointRadius: 0.2,
              fill: false,
            },
          ],
        },
        options: {
          tooltips: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            xAxes: [{}],
            yAxes: [
              {
                stacked: false,
                ticks: {
                  suggestedMin: 0,
                  suggestedMax: 1,
                },
              },
            ],
          },
        },
      })
    </script>
  </body>

  <script>
    var Sol
    var stP
    function show(ele) {
      // GET THE SELECTED VALUE FROM <select> ELEMENT AND SHOW IT.
      var msg = document.getElementById('msg')
      msg.innerHTML =
        'Selected State: <b>' +
        ele.options[ele.selectedIndex].text +
        '</b> </br>' +
        'ID: <b>' +
        ele.value +
        '</b> Fit date: '
      stP = params[ele.value]
      msg.innerHTML += stP.Date
      Sol = get_solution(1, stP)
      if (!('m100' in stP)) {
        m100 = 0
        while (m100 < Sol.deaths.length && Sol.deaths[m100] < 100) m100++
        stP['m100'] = m100
      }
      infectChart.data.datasets[1].label = stP['Name'] + ' Modeled cases'
      xmlhttp.open(
        'GET',
        'https://api.covidtracking.com/v1/states/' + stP['Abbrev'] + '/daily.json',
        true
      )
      xmlhttp.send()
    }
  </script>

  <script>
    //This solver is lifted from the GABGOH SEIR visualization tool.
    //Modified to be compatible with the parameter jsons for our fits
    var Integrators = {
      Euler: [[1]],
      Midpoint: [
        [0.5, 0.5],
        [0, 1],
      ],
      Heun: [
        [1, 1],
        [0.5, 0.5],
      ],
      Ralston: [
        [2 / 3, 2 / 3],
        [0.25, 0.75],
      ],
      K3: [
        [0.5, 0.5],
        [1, -1, 2],
        [1 / 6, 2 / 3, 1 / 6],
      ],
      SSP33: [
        [1, 1],
        [0.5, 0.25, 0.25],
        [1 / 6, 1 / 6, 2 / 3],
      ],
      SSP43: [
        [0.5, 0.5],
        [1, 0.5, 0.5],
        [0.5, 1 / 6, 1 / 6, 1 / 6],
        [1 / 6, 1 / 6, 1 / 6, 1 / 2],
      ],
      RK4: [
        [0.5, 0.5],
        [0.5, 0, 0.5],
        [1, 0, 0, 1],
        [1 / 6, 1 / 3, 1 / 3, 1 / 6],
      ],
      RK38: [
        [1 / 3, 1 / 3],
        [2 / 3, -1 / 3, 1],
        [1, 1, -1, 1],
        [1 / 8, 3 / 8, 3 / 8, 1 / 8],
      ],
    }

    // f is a func of time t and state y
    // y is the initial state, t is the time, h is the timestep
    // updated y is returned.
    var integrate = (m, f, y, t, h) => {
      for (var k = [], ki = 0; ki < m.length; ki++) {
        var _y = y.slice(),
          dt = ki ? m[ki - 1][0] * h : 0
        for (var l = 0; l < _y.length; l++)
          for (var j = 1; j <= ki; j++) _y[l] = _y[l] + h * m[ki - 1][j] * k[ki - 1][l]
        k[ki] = f(t + dt, _y, dt)
      }
      for (var r = y.slice(), l = 0; l < _y.length; l++)
        for (var j = 0; j < k.length; j++) r[l] = r[l] + h * k[j][l] * m[ki - 1][j]
      return r
    }

    function get_solution(dt, parms) {
      var interpolation_steps = 10
      var steps = 400 * interpolation_steps
      var dt = dt / interpolation_steps
      var sample_step = interpolation_steps
      var N = parms.Population

      var method = Integrators['RK4']
      function f(t, x) {
        // SEIR ODE
        var R0 = parms.R0
        if (t >= parms.Tintervention) {
          R0 = parms.R0_intervention
        }
        if (t >= parms.Tintervention + parms.intervention_duration) {
          R0 = parms.R0_newnormal
        }

        var S = x[0] // Susectable
        var E = x[1] // Exposed
        var I = x[2] // Infectious
        var Mild = x[3] // Recovering (Mild)
        var Severe = x[4] // Recovering (Severe)
        var Fatal = x[5] // Recovering (Fatal)
        var R_Mild = x[6] // Recovered
        var R_Severe = x[7] // Recovered
        var R_Fatal = x[8] // Dead

        var dS = (-R0 / parms.Tinf) * I * S
        var dE = (R0 / parms.Tinf) * I * S - E / parms.Tinc
        var dI = E / parms.Tinc - I / parms.Tinf
        var dMild = (parms.pMild * I) / parms.Tinf - Mild / parms.Tmrec
        var dSevere =
          ((1 - parms.pMild - parms.pFatal) * I) / parms.Tinf - Severe / parms.Threc
        var dFatal = (parms.pFatal * I) / parms.Tinf - Fatal / parms.Tfat
        var dR_Mild = Mild / parms.Tmrec
        var dR_Severe = Severe / parms.Threc
        var dR_Fatal = Fatal / parms.Tfat

        //      0   1   2   3      4        5          6       7        8
        return [dS, dE, dI, dMild, dSevere, dFatal, dR_Mild, dR_Severe, dR_Fatal]
      }

      var v = [1 - 1 / N, 0, 1 / N, 0, 0, 0, 0, 0, 0]
      var t = 0

      var F = []
      var TI = []
      var DC = []

      while (steps--) {
        if ((steps + 1) % sample_step == 0) {
          //    Dead   Doc Cases                Recovered        Infectious   Exposed
          //P.push([ N*v[8], N*(v[4]+v[5]+v[7]+v[8]),  N*(v[6] + v[7]), N*v[2],    N*v[1] ])
          F.push(N * v[8])
          DC.push(N * (v[4] + v[5] + v[7] + v[8]))
          TI.push(N * (1 - v[0]))
        }
        v = integrate(method, f, v, t, dt)
        t += dt
      }
      return {
        deaths: F,
        total_infected: TI,
        cases: DC,
      }
    }

    var caseData = new Array(366).fill(0)
    var deathData = new Array(366).fill(0)
    var modelCases = new Array(366).fill(0)
    function updateactuals() {
      if (this.readyState == 4 && this.status == 200) {
        stdata = JSON.parse(this.responseText).reverse()
        var d100 = 0
        for (i = 0; i < stdata.length; i++) {
          dt = stdata[i].date.toString()
          dt = Date.parse(
            dt.substring(4, 6) + '/' + dt.substring(6, 8) + '/' + dt.substring(0, 4)
          )
          if (dt >= startDate && dt <= endDate) {
            var j = parseInt((dt - startDate) / (24 * 3600 * 1000))
            caseData[j] = stdata[i].positive
            deathData[j] = stdata[i].death
            if (d100 == 0 && stdata[i].death > 100) d100 = j
          }
        }
        infectChart.data.datasets[0].data = caseData
        of = stP.m100 - d100
        if (of < 0) modelCases = new Array(-of).fill(0).concat(Sol.cases)
        else modelCases = Sol.cases.slice(of)
        infectChart.data.datasets[1].data = modelCases
        infectChart.update()
      }
    }

    var xmlhttp = new XMLHttpRequest()
    var url = 'https://candell.000webhostapp.com/getseirparams/us/all/params.json'
    var params
    xmlhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        params = JSON.parse(this.responseText)
        var ele = document.getElementById('sel')
        for (var i = 0; i < params.length; i++) {
          ele.innerHTML =
            ele.innerHTML + '<option value=' + i + '>' + params[i]['Name'] + '</option>'
        }
        //future reads are the actuals for the states
        xmlhttp.onreadystatechange = updateactuals
      }
    }
    xmlhttp.open('GET', url, true)
    xmlhttp.send()

    var startDate = new Date('2020-02-01')
    var endDate = new Date('2021-02-01')
    var dtarr = new Array(),
      dt = new Date(startDate)
    while (dt < endDate) {
      dtarr.push(dt.getMonth() + 1 + '/' + dt.getDate() + '/' + dt.getFullYear())
      dt.setDate(dt.getDate() + 1)
    }
    infectChart.data.labels = dtarr
    console.log(dtarr)
  </script>
</html>
